---
title: 'EDA: Drafting Pitchers'
author: "Erin Franke"
date: "10/25/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

```{r}
library(tidyverse)
pitchers_complete <- read_rds("data/pitchers_complete.rds")
```


### Basic EDA exploration when Tommy John surgeries are happening and particularly for who

Summary of proportion of pitchers receiving Tommy John surgery broken down by high school and college:
```{r}
#7.46% of drafted pitchers have received surgery 
#7.57% of college draftees got surgery and 7.17% of HS draftees got surgery 
pitchers_complete %>%
  group_by(had_surgery, hs_draftee) %>%
  count() %>%
  group_by(hs_draftee) %>%
  summarize(had_surgery, prop = n/sum(n))
```

Surgeries are occurring before the draft more often for those that do not debut. For those that debut, surgeries more often come after the draft (either before or after debuting). 
```{r}
pitchers_complete %>%
  filter(had_surgery == 1) %>%
  group_by(mlb_g, surgery_time_binary)%>%
  count() %>%
  group_by(mlb_g) %>%
  summarize(mlb_g, surgery_time_binary, prop = n/sum(n)) %>%
  mutate(mlb_g = recode(mlb_g, "0"="no debut", "1" = "debuted")) %>%
  ggplot(aes(x=mlb_g, y=prop, fill=surgery_time_binary))+
  geom_col()+
  theme_minimal()+
  labs(x = "", y="", title = "Tommy John surgeries occur more often before the draft for players that do not debut", fill = "") +
  scale_fill_manual(values = c("darkgreen", "goldenrod2"))+
 scale_y_continuous(expand = c(0,0))+
  theme(plot.title.position = "plot", 
        plot.title = element_text(size=10))
```

When filtering out surgeries taking place after a player debuts, we look at the proportion of players that debut for those not having surgery and those that had surgery either before being drafted or after being drafted (but before debuting if they did). We see that the proportion of players that debut is higher for players receiving the surgery. This could be for several reasons: 

1. The surgery database is more likely to know of players that are “elite”, which is what is making those that received surgery after debut have a much better round than those that did not get surgery - this is also why the proportion graph shows players that have had surgery more likely to debut. 

2. Players who are more elite for whatever reason are more prone to getting surgery (perhaps they worked really hard or had a really good curveball).

3. If they have a choice (blow elbow in minor) - if you are a more elite prospect, you are more often going to say you will get the surgery and keep going. Does the no surgery group contain some players who did get hurt, but opted to end their career instead of having the surgery (maybe they did not have good chances anyway)?
```{r}
pitchers_complete %>%
  filter(surgery_time != "after debut") %>%
  mutate(had_surgery = as.factor(had_surgery), 
         had_surgery = recode(had_surgery, "0"="no surgery", "1" = "surgery")) %>%
  group_by(mlb_g, had_surgery)%>%
  count() %>%
  group_by(had_surgery) %>%
  summarize(mlb_g, had_surgery, prop = n/sum(n)) %>%
  mutate(mlb_g = recode(mlb_g, "0"="no debut", "1" = "debuted")) %>%
  ggplot(aes(x=had_surgery, y=prop, fill=mlb_g))+
  geom_col()+
  theme_minimal()+
  labs(x = "", y="", title = "Players that recieve Tommy John surgery debut at a higher rate than those that don't", fill = "") +
  scale_fill_manual(values = c("darkgreen", "goldenrod2"))+
 scale_y_continuous(expand = c(0,0))+
  theme(plot.title.position = "plot", 
        plot.title = element_text(size=10))
```

Looking at the mean draft round for players that did not have surgery, and then comparing the draft round for players that had surgery before and after the draft. Players that had surgery before the draft are slightly penalized in comparison to those that had it before the draft.
```{r}
pitchers_complete %>%
  mutate(round = as.numeric(round)) %>%
  filter(surgery_time != "after debut") %>%
  mutate(had_surgery = as.factor(had_surgery), 
         had_surgery = recode(had_surgery, "0"="no surgery", "1" = "surgery")) %>%
  group_by(had_surgery, surgery_time_binary)%>%
  summarize(round(mean(round, na.rm=TRUE), 1))
```

Comparing results of debut/no debut for players that had surgery before draft, had surgery after draft, and did not have surgery. 
```{r}
pitchers_complete %>%
  filter(surgery_time != "after debut") %>%
  mutate(had_surgery = as.factor(had_surgery), 
         had_surgery = recode(had_surgery, "0"="no surgery", "1" = "surgery")) %>%
  group_by(mlb_g, had_surgery, surgery_time_binary)%>%
  count() %>%
  group_by(surgery_time_binary) %>%
  summarize(n, mlb_g, surgery_time_binary, prop = n/sum(n)) %>%
  mutate(mlb_g = recode(mlb_g, "0"="no debut", "1" = "debuted")) %>%
  ggplot(aes(x=surgery_time_binary, y=prop, fill=mlb_g))+
  geom_col()+
  theme_minimal()+
  labs(x = "", y="", title = "Tommy John Surgery Occurances", fill = "") +
  scale_fill_manual(values = c("darkgreen", "goldenrod2"))+
 scale_y_continuous(expand = c(0,0))
```

Stratified by round: compare surgery/debut results in each of first 10 rounds
Ensures we are comparing similar level prospects 
Best comparison between the never surgery and after draft surgery -at the time of the draft, these two groups were essentially identical

```{r}
pitchers_complete %>%
   filter(surgery_time != "after debut", surgery_time_binary %in% c("after draft", "no surgery"), round %in% c("1", "2", "3", "4", "5")) %>%
  mutate(had_surgery = as.factor(had_surgery), 
         had_surgery = recode(had_surgery, "0"="no surgery", "1" = "surgery")) %>%
  group_by(mlb_g, had_surgery, surgery_time_binary)%>%
  count() %>%
  group_by(surgery_time_binary) %>%
  summarize(n, mlb_g, surgery_time_binary, prop = n/sum(n))
  
  
  

```

When we only look at the top 5 rounds, we are restricting ourselves to only good players, therefore explanation 3 is no longer valid. 
