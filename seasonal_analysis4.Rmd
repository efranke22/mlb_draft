---
title: "Seasonal Stats"
author: "Erin Franke"
date: "11/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

```{r}
library(tidyverse)
library(lubridate)
library(readxl)
pitchers_complete <- read_rds("data/pitchers_complete.rds")
seasonal <- read_excel("data/seasonPitcher.xls")
pitchers_debut <- pitchers_complete %>%
  filter(mlb_g == 1) %>%
  mutate(starter = case_when(GS >= 1 ~ "starter", 
                             TRUE ~ "reliever"), 
         draft_to_debut = time_length(difftime(Debut, apprx_draft_date), "years"))
```

One important step will be to create an aging curve. Some EDA that gets into that: 
```{r}
#ERA+ overtime
seasonal %>%
  filter(IP > 50) %>%
  ggplot(aes(x=Year, y=`ERA+`))+
  geom_point()+
  geom_smooth()

#try modeling each player's individual stats 
players <- seasonal %>%
  group_by(Player) %>%
  summarize(n = n(), IP) %>%
  filter(IP >10)
  
players_sample <- players[sample(nrow(players), 20), ]

seasonal %>%
  filter(Player %in% players_sample$Player) %>%
  ggplot(aes(x = Age, y = `ERA+`, group = as.factor(Player))) +
  geom_smooth(method = "loess", se = FALSE,
              color = "gray", size = 0.5)+
  theme_classic()
```

Must create a dataset for seasonal data that combines with the pitcher information (debut date, draft info, if they had Tommy john surgery, etc). 
First, do this for players only that underwent surgery in the major leages. 
```{r}
#filter pitchers debut data set to only include players that had surgery after debut
surgeryPostDebut <- pitchers_debut %>%
  filter(surgery_time == "after debut") %>%
  rename(draftYear = year, 
         debutAge = Age, 
         careerERA = ERA, 
         careerG = G, 
         careerGS = GS, 
         careerGF = GF, 
         careerCG = CG, 
         careerW = W, 
         careerIP = IP, 
         careerSV = SV, 
         careerSO = SO, 
         careerWHIP = WHIP) %>%
  select(name_first_last, birth_date, hs_draftee, Debut, round, debutAge, draftYear, pick, From, To, Yrs, ASG, WAR, careerERA, careerG, careerGS, careerGF, careerCG, careerW, careerIP, careerSV, careerSV, careerSO, careerWHIP, surgery_date, apprx_draft_date, surgery_time) %>%
  group_by(name_first_last) %>%
  arrange(surgery_date) %>%
  mutate(surgery_number = paste0("Surgery ", row_number())) %>%
  pivot_wider(id_cols = c(name_first_last:careerWHIP,apprx_draft_date, surgery_time), names_from = surgery_number, values_from = surgery_date) %>%
  filter(name_first_last != "Scott Baker") #this is giving me trouble because they have the same name, will fix later

#get seasonal stats only for players that had surgery
surgery_seasonal <- seasonal %>%
  filter(Player %in% surgeryPostDebut$name_first_last) %>%
  group_by(Player, Year) %>%
  mutate(nteam = n()) #shows how many teams they played on in a season
  
#filter for cases when a player played on two teams in a single season. We need to combine these rows. 
surgery_seasonal_2teams <- surgery_seasonal%>%
  filter(nteam == 2) %>%
  group_by(Player, Year) %>%
  summarize(SO = sum(SO), Age = mean(Age), G = sum(G), GS = sum(GS), CG = sum(CG), SHO = sum(SHO), GF = sum(GF), W = sum(W), L = sum(L), `W-L%` = 1, SV = sum(SV), IP = sum(IP), H = sum(H), R = sum(R), ER = sum(ER), BB = sum(BB), ERA = 1, `K%` = 1, `BB%` = 1, `ERA+` = mean(`ERA+`), HR = sum(HR), BF = sum(BF), AB = sum(AB), `2B` = sum(`2B`), `3B` = sum(`3B`), `IBB` = sum(`IBB`), HBP = sum(HBP), SH = sum(SH), SF = sum(SF), GDP = sum(GDP), SB = sum(SB), CS = sum(CS), PO = sum(PO), BK = sum(BK), WP = sum(WP), BA = mean(BA, na.rm=TRUE), OBP = mean(OBP, na.rm=TRUE), SLG = mean(SLG), OPS = mean(OPS), `OPS+` = mean(`OPS+`), Pit = sum(Pit), Str = sum(Str)) %>%
  distinct() %>%
  mutate(`W-L%` = round(W/(W+L), 2), 
         ERA = round((9*ER)/IP, 2), 
         `K%` = round(SO/AB, 2), 
         `BB%` = round(BB/AB, 2)) %>%
  mutate(Tm = "2teams", Lg = "NL/AL")

#filter for seasons where a player only played on one team that season. Order the columns so they are in the same order as the new 2 team data
surgery_seasonal_1team = surgery_seasonal %>%
  filter(nteam == 1) %>%
  select(Player, Year, SO, Age, G, GS, CG, SHO, GF, W, L, `W-L%`, SV, IP, H, R, ER, BB, ERA, `K%`, `BB%`, `ERA+`, HR, BF, AB, `2B`, `3B`, IBB, HBP, SH, SF, GDP, SB, CS, PO, BK, WP, BA, OBP, SLG, OPS, `OPS+`, Pit, Str, Tm, Lg)

#row bind the one team and two team data
surgery_seasonal_joined = rbind(surgery_seasonal_2teams, surgery_seasonal_1team)

#join this with the surgeryPostDebut data to include career stats, draft information, birthdate, surgery info, and other crucial information. 
surgery_seasonal_complete <- surgery_seasonal_joined %>%
  left_join(surgeryPostDebut, by = c("Player" = "name_first_last"))  %>%
  mutate(surgery1Year = year(`Surgery 1`), 
         statsTime = case_when(Year <= surgery1Year ~ "before", 
                               Year > surgery1Year ~ "after"))
```

Code for weighted mean
```{r}
surgery_seasonal_2teams <- surgery_seasonal%>%
  filter(nteam == 2) %>%
  group_by(Player, Year) %>%
  summarize(SO = sum(SO), Age = mean(Age), G = sum(G), GS = sum(GS), CG = sum(CG), SHO = sum(SHO), GF = sum(GF), W = sum(W), L = sum(L), `W-L%` = 1, SV = sum(SV), IP = sum(IP), H = sum(H), R = sum(R), ER = sum(ER), BB = sum(BB), ERA = 1, `K%` = 1, `BB%` = 1, `ERA+` = weighted.mean(`ERA+`, w=IP), HR = sum(HR), BF = sum(BF), AB = sum(AB), `2B` = sum(`2B`), `3B` = sum(`3B`), `IBB` = sum(`IBB`), HBP = sum(HBP), SH = sum(SH), SF = sum(SF), GDP = sum(GDP), SB = sum(SB), CS = sum(CS), PO = sum(PO), BK = sum(BK), WP = sum(WP), BA = weighted.mean(BA, w=IP), OBP = weighted.mean(OBP, w=IP), SLG = weighted.mean(SLG, w=IP), OPS = weighted.mean(OPS, w=IP), `OPS+` = weighted.mean(`OPS+`, w=IP), Pit = sum(Pit), Str = sum(Str), birth_date) %>%
  distinct() %>%
  mutate(`W-L%` = W/(W+L), 
         ERA = (9*ER)/IP, 
         `K%` = SO/AB, 
         `BB%` = BB/AB) %>%
  mutate(Tm = "2teams", Lg = "NL/AL")
```


Next, do this for players that have and have not had surgery. 
```{r}
#seasonal stats for both players that have and have not have surgery
seasonal_joined <- pitchers_debut %>%
  rename(draftYear = year, 
         debutAge = Age, 
         careerERA = ERA, 
         careerG = G, 
         careerGS = GS, 
         careerGF = GF, 
         careerCG = CG, 
         careerW = W, 
         careerIP = IP, 
         careerSV = SV, 
         careerSO = SO, 
         careerWHIP = WHIP) %>%
  select(name_first_last, birth_date, hs_draftee, Debut, round, debutAge, draftYear, pick, From, To, Yrs, ASG, WAR, careerERA, careerG, careerGS, careerGF, careerCG, careerW, careerIP, careerSV, careerSV, careerSO, careerWHIP, surgery_date, tj_surgeon, surgery_age, apprx_draft_date, surgery_time) %>%
  full_join(seasonal, by = c("name_first_last" = "Player"))
```

Create data that compares basic stats before and after surgery. 
```{r}
#put data in format to compare seasonal stats before and after player's surgery
stats_b4after_surgery <- surgery_seasonal %>%
  group_by(name_first_last, statsTime) %>%
  summarize(meanSO = mean(SO), meanG = mean(G), meanGS = mean(GS), meanW = mean(W), meanL = mean(L), meanWL = mean(`W-L%`), meanSV = mean(SV), meanIP = mean(IP), meanERA = mean(ERA), meanFIP = mean(FIP), meanK = mean(`K%`), meanBB = mean(`BB%`), meanERAplus = mean(`ERA+`), meanBAbip = mean(BAbip), meanOBP = mean(OBP), meanSLG = mean(SLG), meanOPS = mean(OPS))
```

When does surgery typically happen in a player's career?
```{r}
careerSurgTime <- surgery_seasonal %>%
  group_by(name_first_last, statsTime) %>%
  count() %>%
  pivot_wider(id_cols = name_first_last, names_from = statsTime, values_from = n) %>%
  select(-`NA`)

careerSurgTime$after <- replace_na(careerSurgTime$after, 0)
careerSurgTime$before <- replace_na(careerSurgTime$before, 0)

careerSurgTime <- careerSurgTime %>%
  mutate(career_length = before + after) %>%
  mutate(prop = round(before/(before+after), 2))

careerSurgTime %>%
  ggplot(aes(x=prop))+
  geom_boxplot()+
  theme_classic()
```

Two models, one with IP and one with ERA+
Normalize IP for age 
Create an aging curve? 
Find league average whip (weighted average). 
Modeling: before after dummy for tommy john, person's age (potentially as a categorical) or a generalized additive model. 
Broad investigation of tommy john surgery. Can we include players that never had surgery as an indicator of 0?
